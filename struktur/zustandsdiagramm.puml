@startuml Buchhandlung_SPA_Zustandsdiagramm
!theme vibrant
skinparam backgroundColor #F8F9FA
skinparam state {
  BackgroundColor<<new>> #10B981
  BorderColor<<new>> #059669
  BackgroundColor<<enhanced>> #3B82F6
  BorderColor<<enhanced>> #2563EB
  BackgroundColor<<auth>> #F59E0B
  BorderColor<<auth>> #D97706
}

title Buchhandlung SPA - Zustandsdiagramm\n(Stand: Dezember 2025)

[*] --> Initialisierung

state Initialisierung {
  [*] --> ThemeErkannt
  ThemeErkannt --> DarkMode : prefers-color-scheme: dark
  ThemeErkannt --> LightMode : prefers-color-scheme: light
  DarkMode --> ThemeGespeichert
  LightMode --> ThemeGespeichert
  ThemeGespeichert --> AuthStateCheck
  AuthStateCheck --> SessionGueltig : Token vorhanden
  AuthStateCheck --> NichtAngemeldet : Kein Token
  SessionGueltig --> [*]
  NichtAngemeldet --> [*]
}

Initialisierung --> Startseite

state Startseite <<enhanced>> {
  [*] --> StatistikenLaden
  StatistikenLaden --> AnimationStarten : Daten geladen
  AnimationStarten --> CarouselsLaden

  state CarouselsLaden {
    [*] --> NeuImProgramm
    [*] --> BeliebteeBuecher
    [*] --> Schwabenpreis

    NeuImProgramm : GraphQL Query\n(sortierung: preisDesc)
    BeliebteeBuecher : Filter Rating >= 4
    Schwabenpreis : Filter lieferbar\nsortierung: preisAsc
  }

  CarouselsLaden --> InteraktiveBereit
  InteraktiveBereit --> [*]
}

Startseite --> Navigation

state Navigation {
  [*] --> RouteAuswahl
  RouteAuswahl --> Suche
  RouteAuswahl --> BuchDetail
  RouteAuswahl --> Warenkorb
  RouteAuswahl --> Merkliste
  RouteAuswahl --> NeuesBuch : AuthGuard
  RouteAuswahl --> Login
  RouteAuswahl --> Impressum
  RouteAuswahl --> Kontakt
}

state AuthGuard <<auth>> {
  [*] --> TokenPruefen
  TokenPruefen --> Autorisiert : Token gültig
  TokenPruefen --> NichtAutorisiert : Kein/ungültiger Token
  NichtAutorisiert --> ReturnUrlSpeichern
  ReturnUrlSpeichern --> LoginRedirect
  LoginRedirect --> Login
  Autorisiert --> [*]
}

state Login <<auth>> {
  [*] --> FormularAnzeigen
  FormularAnzeigen --> CredentialsEingeben
  CredentialsEingeben --> FormValidation
  FormValidation --> CredentialsEingeben : Invalid
  FormValidation --> KeycloakAuth : Valid

  state KeycloakAuth {
    [*] --> TokenRequest
    TokenRequest --> AccessTokenErhalten : Erfolg
    TokenRequest --> LoginFehler : 401/403
    AccessTokenErhalten --> TokenSpeichern
    TokenSpeichern --> LocalStoragePersist
    LocalStoragePersist --> AuthStateUpdate
    AuthStateUpdate --> [*]
  }

  KeycloakAuth --> ReturnUrlNavigate : Erfolg
  KeycloakAuth --> FehlerAnzeigen : Fehler
  FehlerAnzeigen --> FormularAnzeigen
  ReturnUrlNavigate --> [*]
}

state Suche {
  [*] --> SuchformularAnzeigen
  SuchformularAnzeigen --> SucheAusfuehren : Suchkriterien eingeben
  SucheAusfuehren --> ErgebnisseLaden : GraphQL Query
  ErgebnisseLaden --> ErgebnisseAnzeigen
  ErgebnisseAnzeigen --> Pagination
  Pagination --> ErgebnisseAnzeigen : Seite wechseln
  ErgebnisseAnzeigen --> BuchDetail : Buch auswählen
}

state BuchDetail <<enhanced>> {
  [*] --> BuchLaden
  BuchLaden --> DetailsAnzeigen : GraphQL getById

  state DetailsAnzeigen {
    [*] --> CoverAnzeigen
    [*] --> ProduktinfoAnzeigen
    [*] --> BeschreibungAnzeigen
    [*] --> AutorBiographieAnzeigen
    [*] --> AehnlicheBuecherLaden

    CoverAnzeigen : Dynamisches SVG\n16 Farbvarianten
    ProduktinfoAnzeigen : Preis, Rating,\nLieferbarkeit
    BeschreibungAnzeigen : Volltext-Beschreibung\nmit Card-Design
    AutorBiographieAnzeigen : Autor-Biographie\nmit Card-Design
    AehnlicheBuecherLaden : GraphQL Query\ngleiche Buchart
  }

  DetailsAnzeigen --> InteraktionWarten
  InteraktionWarten --> WarenkorbHinzufuegen : "In den Warenkorb"
  InteraktionWarten --> MerklisteToggle : "Merken"

  WarenkorbHinzufuegen --> WarenkorbService
  MerklisteToggle --> MerklisteService
}

state WarenkorbService <<new>> {
  [*] --> ItemPruefen
  ItemPruefen --> ItemVorhanden : existiert
  ItemPruefen --> ItemNeu : neu

  ItemVorhanden --> MengeErhoehen
  ItemNeu --> ItemHinzufuegen

  MengeErhoehen --> LocalStorageSpeichern
  ItemHinzufuegen --> LocalStorageSpeichern
  LocalStorageSpeichern --> BehaviorSubjectUpdate
  BehaviorSubjectUpdate --> [*]
}

state Warenkorb <<new>> {
  [*] --> WarenkorbLaden
  WarenkorbLaden --> LocalStorageAbrufen
  LocalStorageAbrufen --> ItemsAnzeigen

  state ItemsAnzeigen {
    [*] --> TabelleDesktop
    [*] --> CardsMobile
    [*] -> GesamtpreisBerechnen

    TabelleDesktop : Responsive Table\nab lg-Breakpoint
    CardsMobile : Bootstrap Cards\nbis md-Breakpoint
  }

  ItemsAnzeigen --> InteraktionWarten
  InteraktionWarten --> MengeAendern : +/- Button
  InteraktionWarten --> ItemEntfernen : Entfernen
  InteraktionWarten --> WarenkorbLeeren : Alle entfernen

  MengeAendern --> WarenkorbService
  ItemEntfernen --> WarenkorbService
  WarenkorbLeeren --> WarenkorbService
}

state MerklisteService <<new>> {
  [*] --> ItemPruefen
  ItemPruefen --> ItemVorhanden : existiert
  ItemPruefen --> ItemNeu : neu

  ItemVorhanden --> ItemEntfernen : Toggle aus
  ItemNeu --> ItemHinzufuegen : Toggle an

  ItemEntfernen --> LocalStorageSpeichern
  ItemHinzufuegen --> LocalStorageSpeichern
  LocalStorageSpeichern --> BehaviorSubjectUpdate
  BehaviorSubjectUpdate --> [*]
}

state Merkliste <<new>> {
  [*] --> MerklisteLaden
  MerklisteLaden --> LocalStorageAbrufen
  LocalStorageAbrufen --> GridAnzeigen

  state GridAnzeigen {
    [*] --> ResponsivesGrid
    ResponsivesGrid : col-12 col-md-6\ncol-lg-4
    ResponsivesGrid --> BuchCards
    BuchCards --> RatingSterne
    BuchCards --> Preis
  }

  GridAnzeigen --> InteraktionWarten
  InteraktionWarten --> ItemEntfernen : "Entfernen"
  InteraktionWarten --> ZuDetails : "Details ansehen"

  ItemEntfernen --> MerklisteService
  ZuDetails --> BuchDetail
}

state NeuesBuch <<enhanced>> {
  [*] --> AuthPruefen
  AuthPruefen --> FormularAnzeigen : Eingeloggt
  AuthPruefen --> LoginRedirect : Nicht eingeloggt

  state FormularAnzeigen {
    [*] --> ISBNGenerieren
    ISBNGenerieren : Automatische ISBN-13\nmit Prüfziffer
    ISBNGenerieren --> FormularBereit
  }

  FormularBereit --> DatenEingeben
  DatenEingeben --> ValidationPruefen : Submit

  state ValidationPruefen {
    [*] --> TitelPruefen
    TitelPruefen --> PreisPruefen : OK
    TitelPruefen --> FehlerSammeln : Fehler
    PreisPruefen --> RatingPruefen : OK
    PreisPruefen --> FehlerSammeln : Fehler
    RatingPruefen --> HomepagePruefen : OK
    RatingPruefen --> FehlerSammeln : Fehler
    HomepagePruefen --> ValidationErgebnis : OK
    HomepagePruefen --> FehlerSammeln : Fehler
    FehlerSammeln --> ValidationErgebnis
  }

  ValidationPruefen --> ErrorPopupAnzeigen : Fehler
  ValidationPruefen --> BuchErstellen : Valid

  state ErrorPopupAnzeigen <<new>> {
    [*] --> PopupOeffnen
    PopupOeffnen : Modal-Overlay\nmit Fehlerliste
    PopupOeffnen --> BenutzerBestaetigt
    BenutzerBestaetigt --> PopupSchliessen
  }

  ErrorPopupAnzeigen --> FormularBereit : "Verstanden"

  BuchErstellen --> GraphQLMutation

  state GraphQLMutation {
    [*] --> AuthHeaderSetzen
    AuthHeaderSetzen : Bearer Token
    AuthHeaderSetzen --> MutationSenden
    MutationSenden --> ErfolgAnzeigen : 201 Created
    MutationSenden --> ISBNKonflikt : ISBN existiert
    MutationSenden --> ServerFehler : 4xx/5xx
  }

  ISBNKonflikt --> NeueISBNGenerieren
  NeueISBNGenerieren --> ErrorPopupAnzeigen
  ServerFehler --> ErrorPopupAnzeigen

  state ErfolgAnzeigen <<new>> {
    [*] --> SuccessPopupOeffnen
    SuccessPopupOeffnen : Grünes Modal\n"Buch wurde angelegt!"
    SuccessPopupOeffnen --> AutoRedirect
    AutoRedirect : Nach 2 Sekunden
  }

  ErfolgAnzeigen --> Suche : Redirect
}

state ThemeToggle <<enhanced>> {
  [*] --> AktuellerTheme
  AktuellerTheme --> Toggle
  Toggle --> DarkMode : war Light
  Toggle --> LightMode : war Dark
  DarkMode --> LocalStorageSpeichern
  LightMode --> LocalStorageSpeichern
  LocalStorageSpeichern --> CSSVariablenUpdate
  CSSVariablenUpdate --> [*]
}

Navigation --> ThemeToggle : Theme-Button

note right of Startseite
  **Features:**
  - Statistik-Animation
  - 3 Buch-Carousels
  - Horizontales Scrolling
  - Responsive Design
  - ChangeDetectorRef
end note

note right of BuchDetail
  **Features:**
  - Beschreibungs-Sektion
  - Autor-Biographie
  - Ähnliche Bücher Carousel
  - Card-Design mit Gradient
  - Mobile-Optimierung
  - ChangeDetectorRef
end note

note right of WarenkorbService
  **Features:**
  - BehaviorSubject State
  - localStorage Persistenz
  - Item-Management
  - Mengen-Verwaltung
  - Preis-Berechnung
end note

note right of MerklisteService
  **Features:**
  - Toggle-Funktion
  - localStorage Persistenz
  - BehaviorSubject State
  - Synchronisation
end note

note right of ThemeToggle
  **Features:**
  - Dark/Light Mode
  - System-Präferenz
  - localStorage Cache
  - CSS Custom Properties
  - Alle Komponenten
end note

note right of Login
  **Keycloak Integration:**
  - OAuth2 Token Flow
  - Session-Persistenz
  - Auto-Logout bei
    Server-Neustart
  - returnUrl Support
end note

note right of NeuesBuch
  **Neu implementiert:**
  - Auto ISBN-13 Generator
  - Prüfziffer-Berechnung
  - Error Popup Modal
  - Success Popup Modal
  - Detaillierte Validierung
  - AuthGuard geschützt
end note

note right of AuthGuard
  **Sicherheit:**
  - canMatch Guard
  - Token-Validierung
  - returnUrl Parameter
  - Automatischer Redirect
end note

@enduml
